# 线性阵型战斗系统 - Unity 测试指南

## 概述

线性阵型战斗系统是对原有 DND 手动战斗系统的重大升级，引入了：

- **横版线性阵型**: 从左到右 12 个位置的战术布局
- **自动战斗 AI**: 智能的多优先级决策系统
- **挂机探索模式**: 类《巴尔德之门》的放置游戏体验
- **战术位置系统**: 前排近战、后排远程、盗贼潜行背刺

## 快速开始

### 方法 1: 自动升级现有场景

1. **打开 DND_Test 场景**

   ```
   Assets/demo2/DND/DND_Test.unity
   ```

2. **运行场景升级工具**

   - 方式 A: 菜单栏选择 `DND -> 升级场景为线性阵型战斗`
   - 方式 B: 在场景中创建空物体，添加`DNDSceneUpgrader`组件，点击"升级场景"按钮

3. **自动测试**
   - 升级完成后，按 F1 开始测试
   - 或使用菜单 `DND -> 测试线性阵型功能`

### 方法 2: 手动集成

1. **添加核心组件**

   ```csharp
   // 在场景中创建空物体，添加以下组件：
   - LinearFormationTestScene       // 主控制器
   - BattleFormationManager        // 阵型管理器
   - AutoBattleAI                  // 自动战斗AI
   - IdleGameManager               // 挂机游戏管理
   - LinearFormationDemo           // 演示系统
   ```

2. **配置引用**
   ```csharp
   // 在LinearFormationTestScene中设置：
   battleUI = 现有的DND_BattleUI组件
   playerPrefabs = 玩家角色预制体列表
   enemyPrefabs = 敌人角色预制体列表
   ```

## 功能特性

### 1. 线性阵型系统

**位置布局**:

```
玩家后排    玩家前排    敌人前排    敌人后排
[0][1][2]   [3][4][5]   [6][7][8]   [9][10][11]
```

**职业定位**:

- **战士**: 自动站位前排(3-5)，承担坦克职责
- **法师**: 自动站位后排(0-2)，施放范围法术
- **盗贼**: 灵活站位，可潜行到敌人后排背刺
- **牧师**: 后排治疗，优先救治濒死队友

### 2. 自动战斗 AI

**决策优先级**:

1. **紧急治疗**: 队友生命值低于 25%
2. **优势攻击**: 有背刺、法术范围等战术优势
3. **位置调整**: 根据职业和战况移动到最佳位置
4. **常规攻击**: 攻击最近或最脆弱的敌人
5. **防御姿态**: 无其他行动时进入防御

**职业特色 AI**:

```csharp
// 战士AI - 前排坦克
- 优先攻击威胁最大的敌人
- 保护后排队友
- 适时使用防御姿态

// 法师AI - 范围输出
- 寻找多目标法术机会
- 保持安全距离
- 优先打击法师和远程单位

// 盗贼AI - 灵活刺杀
- 潜行到敌人后排
- 背刺攻击脆弱目标
- 利用位置优势

// 牧师AI - 治疗支援
- 优先治疗濒死队友
- 辅助法术增强团队
- 攻击威胁最大的敌人
```

### 3. 挂机探索模式

**阶段式进度**:

```
探索阶段 -> 遭遇战 -> 战利品 -> 休息恢复 -> 下一阶段
```

**自动化功能**:

- 自动探索和遭遇战
- 智能战斗决策
- 经验值和装备获取
- 渐进式难度提升

## 测试操作

### 快捷键控制

| 按键 | 功能         | 说明                       |
| ---- | ------------ | -------------------------- |
| F1   | 开始测试     | 创建队伍并开始线性阵型战斗 |
| F2   | 停止测试     | 停止当前战斗和挂机模式     |
| F3   | 切换挂机模式 | 启用/关闭自动探索挂机      |
| F4   | 显示阵型信息 | 查看当前角色位置和状态     |
| F5   | 重置测试     | 清除所有角色重新开始       |

### 控制台命令

```csharp
// 在LinearFormationTestScene组件的上下文菜单中：
[ContextMenu("开始测试")]
[ContextMenu("停止测试")]
[ContextMenu("重置测试")]
[ContextMenu("切换挂机模式")]
[ContextMenu("显示阵型信息")]
```

### GUI 界面

运行时会在屏幕左上角显示：

- 测试状态（运行中/停止）
- 挂机模式状态
- 队伍信息（玩家/敌人数量）
- 快捷键说明

## 参数配置

### LinearFormationTestScene 参数

```csharp
[Header("测试模式")]
public bool autoStart = true;          // 自动开始测试
public bool enableIdleMode = false;    // 启用挂机模式
public float testDuration = 0f;        // 测试时长(0=无限)

[Header("队伍配置")]
public int playerTeamSize = 4;         // 玩家队伍大小
public int enemyTeamSize = 3;          // 敌人队伍大小

[Header("角色预制体")]
public List<GameObject> playerPrefabs; // 玩家角色预制体
public List<GameObject> enemyPrefabs;  // 敌人角色预制体
```

### 职业配置示例

```csharp
// 默认4人小队配置：
1. 圣骑士(Fighter) - 前排坦克，16力量，AC16，35HP
2. 法师(Wizard) - 后排输出，16智力，AC12，22HP
3. 盗贼(Rogue) - 灵活刺客，16敏捷，AC14，28HP
4. 牧师(Cleric) - 后排治疗，16感知，AC15，30HP
```

## 兼容性说明

### 与现有系统的兼容

✅ **完全兼容**:

- 保持原有`DND_BattleUI`功能
- 保持原有`CombatManager`战斗逻辑
- 支持现有角色预制体和配置
- 可与手动战斗模式共存

✅ **数值系统兼容**:

- 使用相同的 DND5E 数值计算
- 攻击检定、伤害计算、豁免检定保持一致
- 状态效果和技能系统完全兼容

✅ **UI 系统兼容**:

- 战斗日志正常显示
- 角色状态 UI 正常更新
- 可在自动/手动模式间切换

### 新增功能

🆕 **线性阵型管理**:

- 12 个固定位置的战术布局
- 基于距离的攻击和移动规则
- 掩护和位置优势计算

🆕 **智能 AI 系统**:

- 多层优先级决策树
- 职业特色行为模式
- 战术位置自动调整

🆕 **挂机游戏循环**:

- 自动探索和战斗
- 渐进式奖励系统
- 放置游戏体验

## 故障排除

### 常见问题

**Q: 运行 F1 没有反应？**
A: 检查控制台是否有错误信息，确保添加了`LinearFormationTestScene`组件

**Q: 角色没有生成？**
A: 检查`playerPrefabs`和`enemyPrefabs`是否配置，或允许创建默认角色

**Q: 战斗不会自动进行？**
A: 确保`AutoBattleAI`组件已添加且启用

**Q: UI 不显示？**
A: 检查`battleUI`引用是否正确指向现有的`DND_BattleUI`组件

### 调试信息

控制台会输出详细的调试信息：

```
=== 开始线性阵型战斗测试 ===
队伍创建完成 - 玩家: 4, 敌人: 3
线性阵型设置完成
战斗系统启动完成
```

使用 F4 快捷键可查看详细的阵型状态：

```
=== 当前队伍状态 ===
玩家队伍 (4人):
  圣骑士_1 - 位置: 3, HP: 35/35
  法师_1 - 位置: 0, HP: 22/22
  盗贼_1 - 位置: 4, HP: 28/28
  牧师_1 - 位置: 1, HP: 30/30
```

## 下一步

测试成功后，可以：

1. **调整参数**: 修改队伍大小、角色配置等
2. **添加自定义角色**: 使用现有角色预制体或创建新的
3. **扩展 AI 行为**: 修改`AutoBattleAI`的决策逻辑
4. **自定义阵型**: 调整`BattleFormationManager`的位置布局
5. **集成到游戏**: 将线性阵型系统集成到完整的游戏流程中

这个系统为 DND 战斗提供了全新的战术深度和自动化体验，同时保持了与现有系统的完全兼容性。
